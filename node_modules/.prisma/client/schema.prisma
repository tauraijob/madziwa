// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Supervisor {
  id           Int                  @id @default(autoincrement())
  fullName     String               @map("fullName")
  email        String               @unique
  passwordHash String?
  pinHash      String?
  phoneNumber  String               @map("phoneNumber")
  nationalId   String               @unique @map("nationalId")
  districtId   Int? // Keep for backward compatibility
  district     District?            @relation("SupervisorPrimaryDistrict", fields: [districtId], references: [id])
  districts    SupervisorDistrict[] @relation("SupervisorDistricts")
  createdAt    DateTime             @default(now()) @map("createdAt")
  updatedAt    DateTime             @updatedAt @map("updatedAt")
  assessments  Assessment[]

  @@map("supervisors")
}

model Student {
  id          Int          @id @default(autoincrement())
  fullName    String       @map("fullName")
  sex         String
  candidateNo String       @unique @map("candidateNo")
  email       String
  schoolName  String       @map("schoolName")
  className   String       @map("className")
  phoneNumber String       @default("") @map("phoneNumber")
  districtId  Int?
  createdAt   DateTime     @default(now()) @map("createdAt")
  updatedAt   DateTime     @updatedAt @map("updatedAt")
  assessments Assessment[]
  district    District?    @relation(fields: [districtId], references: [id])

  @@map("students")
}

model Assessment {
  id                        Int      @id @default(autoincrement())
  assessmentDate            DateTime @map("assessmentDate")
  subject                   String
  topic                     String
  preparationMark           Int      @default(0) @map("preparationMark")
  preparationComment        String   @map("preparationComment")
  lessonPlanningMark        Int      @default(0) @map("lessonPlanningMark")
  lessonPlanningComment     String   @map("lessonPlanningComment")
  environmentMark           Int      @default(0) @map("environmentMark")
  environmentComment        String   @map("environmentComment")
  documentsMark             Int      @default(0) @map("documentsMark")
  documentsComment          String   @map("documentsComment")
  introductionMark          Int      @default(0) @map("introductionMark")
  introductionComment       String   @map("introductionComment")
  developmentMark           Int      @default(0) @map("developmentMark")
  developmentComment        String   @map("developmentComment")
  conclusionMark            Int      @default(0) @map("conclusionMark")
  conclusionComment         String   @map("conclusionComment")
  personalDimensionsMark    Int      @default(0) @map("personalDimensionsMark")
  personalDimensionsComment String   @default("") @map("personalDimensionsComment")
  communityMark             Int      @default(0) @map("communityMark")
  communityComment          String   @default("") @map("communityComment")
  // Research category selection
  selectedResearchCategory  String?  @map("selectedResearchCategory") // "community_service", "innovation", "industrialisation"
  // New: which form was used
  formType                  String   @default("junior") @map("formType")
  overallComment            String   @map("overallComment")
  // Selected category and remaining pillars for offline templates
  selectedCategory          String?  @map("selectedCategory")
  remainingPillars          String?  @map("remainingPillars")
  supervisorId              Int      @map("supervisorId")
  studentId                 Int      @map("studentId")
  createdAt                 DateTime @default(now()) @map("createdAt")
  updatedAt                 DateTime @updatedAt @map("updatedAt")

  supervisor Supervisor @relation(fields: [supervisorId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

model District {
  id                  Int                  @id @default(autoincrement())
  name                String               @unique
  students            Student[]
  admins              AdminUser[]
  supervisors         Supervisor[]         @relation("SupervisorPrimaryDistrict")
  supervisorDistricts SupervisorDistrict[] @relation("DistrictSupervisors")

  @@map("districts")
}

model SupervisorDistrict {
  id           Int        @id @default(autoincrement())
  supervisorId Int
  districtId   Int
  supervisor   Supervisor @relation("SupervisorDistricts", fields: [supervisorId], references: [id], onDelete: Cascade)
  district     District   @relation("DistrictSupervisors", fields: [districtId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("createdAt")

  @@unique([supervisorId, districtId])
  @@map("supervisor_districts")
}

model AdminUser {
  id                 Int       @id @default(autoincrement())
  fullName           String
  email              String    @unique
  passwordHash       String
  role               String    @default("admin") // 'admin' | 'superadmin'
  assignedDistrictId Int?
  assignedDistrict   District? @relation(fields: [assignedDistrictId], references: [id])
  createdAt          DateTime  @default(now()) @map("createdAt")
  updatedAt          DateTime  @updatedAt @map("updatedAt")

  @@map("admin_users")
}

model SystemSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now()) @map("createdAt")
  updatedAt DateTime @updatedAt @map("updatedAt")

  @@map("system_settings")
}
